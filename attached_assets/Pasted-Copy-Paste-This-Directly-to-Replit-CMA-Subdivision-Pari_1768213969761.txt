Copy-Paste This Directly to Replit:
# CMA Subdivision Parity Fix - CRITICAL

## Problem Summary

The initial fix has a **critical domain rule violation**: subdivision data is being sourced from `address.neighborhood` field. This is forbidden. Additionally, the original parity issue (MLS shows 3 results, portal shows 0) has not been verified as resolved.

---

## CRITICAL FIX 1: Subdivision vs Neighborhood Separation

**Current code (WRONG):**
```typescript
const subdivision = addr.subdivision || addr.neighborhood; // ❌ FORBIDDEN
```

**Required fix:**
```typescript
const subdivision = addr.subdivision || addr.SubdivisionName || null; // ✅
// If null, display "Subdivision: N/A" — NEVER substitute neighborhood
```

**Tasks:**
1. Find the normalization code (around lines 813-823) and remove any `addr.neighborhood` fallback for subdivision
2. Query Repliers to find correct ACTRIS subdivision field:
GET https://api.repliers.io/listings?aggregates=address.subdivision,address.SubdivisionName,SubdivisionName&OriginatingSystemName=ACTRIS&limit=1
3. Use ONLY the MLS subdivision field from that response

---

## CRITICAL FIX 2: Re-enable API-Level Subdivision Filtering

**Problem:** Line 507 has subdivision commented out, forcing inefficient local filtering.

**Tasks:**
1. Uncomment line 507 to pass subdivision to Repliers API
2. If direct parameter doesn't work, use search with searchFields:
```typescript
if (searchCriteria.subdivision) {
  params.search = searchCriteria.subdivision;
  params.searchFields = 'address.subdivision';
}
```
3. Log to confirm API-level filtering:
```typescript
console.log('[CMA Search] Subdivision passed to API:', params.subdivision || params.search);
```

---

## CRITICAL FIX 3: Verify Original Parity Test

**This is the actual bug Ryan reported. Must pass before marking complete.**

Run this exact query:
```json
{
  "subdivision": "steiner ranch",
  "propertyType": "Single Family Residence",
  "minSqft": 5400,
  "maxSqft": 6400,
  "minLotAcres": 0.5,
  "maxLotAcres": 1.5,
  "statuses": ["Active", "Active Under Contract", "Closed"],
  "closeDateDays": 150,
  "zipCode": "78732"
}
```

**Expected:** ≥3 results (matching MLS ground truth from screenshots)

Log the result:
```typescript
console.log('[PARITY TEST] Steiner Ranch query results:', {
  count: result.count,
  expected: '≥3 (MLS ground truth)',
  pass: result.count >= 3
});
```

---

## FIX 4: Rental Exclusion Verification

Ensure ALL CMA queries include:
```typescript
params.type = 'Sale'; // Excludes Lease/Rental
```

Add validation:
```typescript
if (params.type !== 'Sale') {
  console.error('[CMA] VIOLATION: Rental exclusion missing');
  params.type = 'Sale';
}
```

---

## FIX 5: Close Date Filter Isolation

Close date must ONLY apply when Closed status is selected:
```typescript
// WRONG - applies to all
params.soldDateFrom = calculateDate(closeDateDays);

// CORRECT - only for Closed
if (statuses.includes('Closed')) {
  params.soldDateFrom = calculateDate(closeDateDays);
}
```

---

## FIX 6: Add Compliance Logging

Add this at the start of every CMA search:
```typescript
console.log('[CMA Compliance]', {
  subdivisionSource: 'MLS field only (not neighborhood)',
  rentalExcluded: params.type === 'Sale',
  statusCodes: params.status,
  closeDateAppliedTo: statuses.includes('Closed') ? 'Closed only' : 'N/A',
  apiLevelFiltering: !!params.subdivision || !!params.search
});
```

---

## Required Test Cases

### Test 1: Original Parity (MUST PASS)
POST /api/cma/search
{
"subdivision": "steiner ranch",
"propertyType": "Single Family Residence",
"minSqft": 5400,
"maxSqft": 6400,
"minLotAcres": 0.5,
"maxLotAcres": 1.5,
"statuses": ["Active", "Active Under Contract", "Closed"],
"closeDateDays": 150,
"zipCode": "78732"
}
Expected: count >= 3

### Test 2: Subdivision Not From Neighborhood
Check logs - if any listing has subdivision value from address.neighborhood while address.subdivision is null = FAIL

### Test 3: Rental Exclusion
POST /api/cma/search
{"zipCode": "78732", "statuses": ["Active", "Closed"]}
Verify: No listings with type="Lease" or "Rental"

### Test 4: Close Date Isolation
Search Active with closeDateDays=30 and without - both should return SAME count

### Test 5: Missing Status Returns 400
POST /api/cma/search
{"zipCode": "78732"}
Expected: HTTP 400

### Test 6: No Subject-Property-Only Fallback
POST /api/cma/search
{"subdivision": "NONEXISTENT999", "statuses": ["Active", "Closed"], "zipCode": "99999"}
Expected: count = 0, empty array (NOT subject property)

---

## Acceptance Criteria

Before marking complete, verify ALL pass:

- [ ] Test 1: Steiner Ranch returns ≥3 results (MLS parity)
- [ ] Test 2: Subdivision NOT sourced from neighborhood field
- [ ] Test 3: No rental/lease listings in results
- [ ] Test 4: Close date doesn't filter Active listings
- [ ] Test 5: Missing status returns 400 error
- [ ] Test 6: Invalid search returns empty, not subject property
- [ ] Compliance logging present in server logs
- [ ] Line 507 uncommented (API-level subdivision filtering)

---

## Files to Modify

1. `server/services/repliers.ts` or `cmaQueryBuilder.ts` - Line 507
2. `server/utils/propertyNormalizer.ts` - Lines 813-823
3. `server/routes/cma.ts` - Compliance logging

---

## DO NOT mark complete until Test 1 returns ≥3 results matching MLS.