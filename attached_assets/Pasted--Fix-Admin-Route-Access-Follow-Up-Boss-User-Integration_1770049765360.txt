# Fix Admin Route Access & Follow Up Boss User Integration

## ⚠️ TESTING REQUIREMENT

**Before declaring complete, you MUST:**
1. Login as Super Admin and verify `/admin` route works (no Access Denied)
2. Verify Follow Up Boss user search/import works
3. Test that imported users can be assigned roles
4. **DO NOT declare complete without testing each feature**

---

## ISSUE 1: `/admin` Route Shows Access Denied for Super Admin

### Problem
When a Super Admin navigates to `/admin`, they see "Access Denied" even though they have Super Admin role and can access `/admin/users` and `/admin/activity-logs`.

### Root Cause
The `/admin` base route likely has:
- No page component assigned, OR
- Incorrect permission check, OR
- Missing route configuration

### Solution

**Option A: Redirect `/admin` to `/admin/users`**

```typescript
// client/src/App.tsx or routes configuration

// Add redirect for /admin base route
<Route path="/admin" element={<Navigate to="/admin/users" replace />} />

// Or in the route configuration
{
  path: '/admin',
  element: <Navigate to="/admin/users" replace />,
}
```

**Option B: Create Admin Dashboard Landing Page**

```typescript
// client/src/pages/admin/AdminDashboard.tsx

import { usePermissions } from '@/hooks/use-permissions';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Users, FileText, Settings, Shield } from 'lucide-react';
import { Link } from 'wouter';

export default function AdminDashboard() {
  const { isSuperAdmin } = usePermissions();
  
  if (!isSuperAdmin) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <Shield className="w-16 h-16 mx-auto text-red-500 mb-4" />
          <h1 className="text-2xl font-bold">Access Denied</h1>
          <p className="text-muted-foreground mt-2">
            You don't have permission to access the Admin Panel.
          </p>
        </div>
      </div>
    );
  }
  
  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-2">Admin Dashboard</h1>
      <p className="text-muted-foreground mb-6">
        Manage users, roles, and system settings
      </p>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <Link href="/admin/users">
          <Card className="cursor-pointer hover:shadow-md transition-shadow">
            <CardHeader className="flex flex-row items-center gap-4">
              <Users className="w-8 h-8 text-primary" />
              <div>
                <CardTitle>User Management</CardTitle>
                <p className="text-sm text-muted-foreground">
                  Manage team members and roles
                </p>
              </div>
            </CardHeader>
          </Card>
        </Link>
        
        <Link href="/admin/activity-logs">
          <Card className="cursor-pointer hover:shadow-md transition-shadow">
            <CardHeader className="flex flex-row items-center gap-4">
              <FileText className="w-8 h-8 text-primary" />
              <div>
                <CardTitle>Activity Logs</CardTitle>
                <p className="text-sm text-muted-foreground">
                  View admin action history
                </p>
              </div>
            </CardHeader>
          </Card>
        </Link>
        
        <Link href="/admin/settings">
          <Card className="cursor-pointer hover:shadow-md transition-shadow">
            <CardHeader className="flex flex-row items-center gap-4">
              <Settings className="w-8 h-8 text-primary" />
              <div>
                <CardTitle>System Settings</CardTitle>
                <p className="text-sm text-muted-foreground">
                  Configure system preferences
                </p>
              </div>
            </CardHeader>
          </Card>
        </Link>
      </div>
    </div>
  );
}
```

**Update Routes:**

```typescript
// client/src/App.tsx

import AdminDashboard from '@/pages/admin/AdminDashboard';

// In routes:
<Route path="/admin">
  <ProtectedRoute minimumRole="super_admin">
    <AdminDashboard />
  </ProtectedRoute>
</Route>
```

---

## ISSUE 2: Follow Up Boss Integration for User Search

### Goal
Pull team members from Follow Up Boss to easily invite/assign roles to users who haven't logged in yet.

### Solution

#### 2.1 Backend: Follow Up Boss API Integration

```typescript
// server/services/followUpBossService.ts

const FUB_API_BASE = 'https://api.followupboss.com/v1';
const FUB_API_KEY = process.env.FOLLOW_UP_BOSS_API_KEY;

interface FUBPerson {
  id: number;
  name: string;
  firstName: string;
  lastName: string;
  emails: { value: string; type: string }[];
  phones: { value: string; type: string }[];
  stage: string;
  assignedTo: number | null;
  created: string;
}

interface FUBUser {
  id: number;
  name: string;
  email: string;
  role: string;
  isActive: boolean;
}

// Get all FUB team members (agents/users in your FUB account)
export async function getFUBTeamMembers(): Promise<FUBUser[]> {
  const response = await fetch(`${FUB_API_BASE}/users`, {
    headers: {
      'Authorization': `Basic ${Buffer.from(FUB_API_KEY + ':').toString('base64')}`,
      'Content-Type': 'application/json',
    },
  });
  
  if (!response.ok) {
    throw new Error(`FUB API error: ${response.status}`);
  }
  
  const data = await response.json();
  return data.users || [];
}

// Search FUB team members by name or email
export async function searchFUBTeamMembers(query: string): Promise<FUBUser[]> {
  const allUsers = await getFUBTeamMembers();
  const lowerQuery = query.toLowerCase();
  
  return allUsers.filter(user => 
    user.name?.toLowerCase().includes(lowerQuery) ||
    user.email?.toLowerCase().includes(lowerQuery)
  );
}
```

#### 2.2 Backend: API Endpoints

```typescript
// server/routes/admin.ts - Add FUB endpoints

import { getFUBTeamMembers, searchFUBTeamMembers } from '../services/followUpBossService';

// GET /api/admin/fub/users - Get all FUB team members
app.get('/api/admin/fub/users', requireAuth, requireMinimumRole('super_admin'), async (req, res) => {
  try {
    const fubUsers = await getFUBTeamMembers();
    
    // Get existing portal users to mark who's already registered
    const portalUsers = await db.select({
      email: users.email,
      role: users.role,
    }).from(users);
    
    const portalEmailSet = new Set(portalUsers.map(u => u.email.toLowerCase()));
    
    // Merge FUB users with portal registration status
    const mergedUsers = fubUsers.map(fubUser => ({
      ...fubUser,
      isRegistered: portalEmailSet.has(fubUser.email?.toLowerCase()),
      portalRole: portalUsers.find(
        p => p.email.toLowerCase() === fubUser.email?.toLowerCase()
      )?.role || null,
    }));
    
    res.json(mergedUsers);
  } catch (error) {
    console.error('FUB API error:', error);
    res.status(500).json({ error: 'Failed to fetch Follow Up Boss users' });
  }
});

// GET /api/admin/fub/users/search - Search FUB team members
app.get('/api/admin/fub/users/search', requireAuth, requireMinimumRole('super_admin'), async (req, res) => {
  try {
    const { q } = req.query;
    if (!q || typeof q !== 'string') {
      return res.status(400).json({ error: 'Search query required' });
    }
    
    const fubUsers = await searchFUBTeamMembers(q);
    res.json(fubUsers);
  } catch (error) {
    console.error('FUB search error:', error);
    res.status(500).json({ error: 'Failed to search Follow Up Boss users' });
  }
});

// POST /api/admin/users/invite - Pre-create user from FUB data
app.post('/api/admin/users/invite', requireAuth, requireMinimumRole('super_admin'), async (req, res) => {
  try {
    const { email, firstName, lastName, role = 'agent' } = req.body;
    const adminUser = req.user;
    
    // Check if user already exists
    const existing = await db.select().from(users).where(eq(users.email, email.toLowerCase()));
    if (existing.length > 0) {
      return res.status(400).json({ error: 'User already exists' });
    }
    
    // Validate role
    if (!['super_admin', 'admin', 'agent'].includes(role)) {
      return res.status(400).json({ error: 'Invalid role' });
    }
    
    // Create user (they'll complete registration on first Google login)
    const [newUser] = await db.insert(users).values({
      email: email.toLowerCase(),
      firstName,
      lastName,
      role,
      isActive: true,
    }).returning();
    
    // Log activity
    await logAdminActivity({
      adminUserId: adminUser.id,
      action: 'USER_INVITED',
      targetUserId: newUser.id,
      newValue: role,
      details: { email, firstName, lastName, source: 'follow_up_boss' },
      req,
    });
    
    res.json({ success: true, user: newUser });
  } catch (error) {
    console.error('Invite user error:', error);
    res.status(500).json({ error: 'Failed to invite user' });
  }
});
```

#### 2.3 Frontend: FUB User Search Component

```typescript
// client/src/components/admin/FUBUserSearch.tsx

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { 
  Select, 
  SelectContent, 
  SelectItem, 
  SelectTrigger, 
  SelectValue 
} from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Search, UserPlus, Check, Loader2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { apiRequest } from '@/lib/queryClient';

interface FUBUser {
  id: number;
  name: string;
  email: string;
  firstName?: string;
  lastName?: string;
  isRegistered: boolean;
  portalRole: string | null;
}

export function FUBUserSearch() {
  const [isOpen, setIsOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedUser, setSelectedUser] = useState<FUBUser | null>(null);
  const [selectedRole, setSelectedRole] = useState<string>('agent');
  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Fetch FUB users
  const { data: fubUsers, isLoading } = useQuery({
    queryKey: ['/api/admin/fub/users'],
    enabled: isOpen,
  });

  // Invite user mutation
  const inviteMutation = useMutation({
    mutationFn: async (userData: { email: string; firstName: string; lastName: string; role: string }) => {
      return apiRequest('/api/admin/users/invite', {
        method: 'POST',
        body: JSON.stringify(userData),
      });
    },
    onSuccess: () => {
      toast({ title: 'User invited successfully' });
      queryClient.invalidateQueries({ queryKey: ['/api/admin/users'] });
      queryClient.invalidateQueries({ queryKey: ['/api/admin/fub/users'] });
      setSelectedUser(null);
      setIsOpen(false);
    },
    onError: (error: any) => {
      toast({ 
        title: 'Failed to invite user', 
        description: error.message,
        variant: 'destructive',
      });
    },
  });

  // Filter users based on search
  const filteredUsers = fubUsers?.filter((user: FUBUser) => {
    if (!searchQuery) return true;
    const query = searchQuery.toLowerCase();
    return (
      user.name?.toLowerCase().includes(query) ||
      user.email?.toLowerCase().includes(query)
    );
  }) || [];

  const handleInvite = () => {
    if (!selectedUser) return;
    
    const nameParts = selectedUser.name?.split(' ') || [];
    inviteMutation.mutate({
      email: selectedUser.email,
      firstName: selectedUser.firstName || nameParts[0] || '',
      lastName: selectedUser.lastName || nameParts.slice(1).join(' ') || '',
      role: selectedRole,
    });
  };

  return (
    <>
      <Button onClick={() => setIsOpen(true)} variant="outline" className="gap-2">
        <UserPlus className="w-4 h-4" />
        Import from Follow Up Boss
      </Button>

      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
          <DialogHeader>
            <DialogTitle>Import Users from Follow Up Boss</DialogTitle>
          </DialogHeader>

          {/* Search */}
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input
              placeholder="Search by name or email..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10"
            />
          </div>

          {/* User List */}
          <div className="flex-1 overflow-y-auto border rounded-lg">
            {isLoading ? (
              <div className="flex items-center justify-center py-8">
                <Loader2 className="w-6 h-6 animate-spin" />
              </div>
            ) : filteredUsers.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">
                No users found
              </div>
            ) : (
              <div className="divide-y">
                {filteredUsers.map((user: FUBUser) => (
                  <div
                    key={user.id}
                    className={`p-3 flex items-center justify-between hover:bg-muted/50 cursor-pointer ${
                      selectedUser?.id === user.id ? 'bg-muted' : ''
                    }`}
                    onClick={() => !user.isRegistered && setSelectedUser(user)}
                  >
                    <div>
                      <p className="font-medium">{user.name}</p>
                      <p className="text-sm text-muted-foreground">{user.email}</p>
                    </div>
                    {user.isRegistered ? (
                      <Badge variant="secondary" className="gap-1">
                        <Check className="w-3 h-3" />
                        Registered ({user.portalRole})
                      </Badge>
                    ) : selectedUser?.id === user.id ? (
                      <Badge>Selected</Badge>
                    ) : (
                      <Badge variant="outline">Not Registered</Badge>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Selected User & Role */}
          {selectedUser && (
            <div className="border rounded-lg p-4 bg-muted/30">
              <p className="text-sm font-medium mb-2">
                Invite: {selectedUser.name} ({selectedUser.email})
              </p>
              <div className="flex items-center gap-4">
                <label className="text-sm">Assign Role:</label>
                <Select value={selectedRole} onValueChange={setSelectedRole}>
                  <SelectTrigger className="w-40">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="agent">Agent</SelectItem>
                    <SelectItem value="admin">Admin</SelectItem>
                    <SelectItem value="super_admin">Super Admin</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          )}

          <DialogFooter>
            <Button variant="outline" onClick={() => setIsOpen(false)}>
              Cancel
            </Button>
            <Button 
              onClick={handleInvite} 
              disabled={!selectedUser || inviteMutation.isPending}
            >
              {inviteMutation.isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
              Invite User
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}
```

#### 2.4 Add to User Management Page

```typescript
// client/src/pages/UserManagement.tsx - Add import button

import { FUBUserSearch } from '@/components/admin/FUBUserSearch';

// In the header section, add:
<div className="flex items-center justify-between mb-6">
  <div>
    <h1 className="text-2xl font-bold">User Management</h1>
    <p className="text-muted-foreground">Manage team member roles and permissions</p>
  </div>
  <div className="flex items-center gap-2">
    <FUBUserSearch />  {/* ADD THIS */}
    <Button onClick={() => navigate('/admin/activity-logs')} variant="outline">
      Activity Logs
    </Button>
  </div>
</div>
```

---

## Environment Variable

Add Follow Up Boss API key to environment:

```bash
# .env or Replit Secrets
FOLLOW_UP_BOSS_API_KEY=your-fub-api-key-here
```

---

## ACCEPTANCE CRITERIA

### Admin Route:
- [ ] `/admin` route accessible to Super Admins (no Access Denied)
- [ ] `/admin` shows dashboard or redirects to `/admin/users`
- [ ] Non-Super Admins still see Access Denied

### Follow Up Boss Integration:
- [ ] "Import from Follow Up Boss" button visible on User Management page
- [ ] Clicking button opens modal with FUB team members
- [ ] Search filters users by name or email
- [ ] Already registered users show "Registered" badge
- [ ] Can select unregistered user and assign role
- [ ] Invite creates user in database
- [ ] Activity log records the invite action

---

## TESTING CHECKLIST

- [ ] Login as Super Admin
- [ ] Navigate to `/admin` - should NOT show Access Denied
- [ ] Go to User Management
- [ ] Click "Import from Follow Up Boss"
- [ ] Verify FUB users load
- [ ] Search for a user
- [ ] Select an unregistered user
- [ ] Choose a role
- [ ] Click Invite
- [ ] Verify user appears in User Management table
- [ ] Check Activity Logs for invite record

---

## FILES TO CREATE/MODIFY

```
server/
├── services/
│   └── followUpBossService.ts    [CREATE - FUB API integration]
└── routes/
    └── admin.ts                   [MODIFY - add FUB endpoints]

client/src/
├── pages/
│   ├── admin/
│   │   └── AdminDashboard.tsx    [CREATE - admin landing page]
│   └── UserManagement.tsx        [MODIFY - add FUB import button]
├── components/
│   └── admin/
│       └── FUBUserSearch.tsx     [CREATE - FUB search modal]
└── App.tsx                        [MODIFY - fix /admin route]
```

---

**⚠️ REMINDER: Test both the /admin route fix AND FUB integration before declaring complete!**