# Super Admin Role Indicator & Render Deployment Readiness

## ⚠️ TESTING REQUIREMENT

**Before declaring complete, you MUST:**
1. Verify role badge/indicator is visible to logged-in users
2. Test that Super Admin sees "Super Admin" indicator
3. Verify all environment variables are properly referenced
4. Test database connection with DATABASE_URL
5. **DO NOT declare complete without testing each item**

---

## PART 1: Role Indicator - Where Am I a Super Admin?

### Issue
Currently there's no visible indicator showing the logged-in user their current role.

### Solution
Add role indicator in multiple locations:

---

### 1.1 Header/Navbar Role Badge

Add a role badge next to the user's name or avatar in the header.

```tsx
// client/src/components/layout/Header.tsx or Navbar.tsx

import { usePermissions } from '@/hooks/use-permissions';
import { Badge } from '@/components/ui/badge';
import { Shield, ShieldCheck, User } from 'lucide-react';

function UserRoleBadge() {
  const { role, isSuperAdmin, isAdmin, roleDisplayName } = usePermissions();
  
  if (isSuperAdmin) {
    return (
      <Badge className="bg-purple-600 hover:bg-purple-700 text-white gap-1">
        <ShieldCheck className="w-3 h-3" />
        Super Admin
      </Badge>
    );
  }
  
  if (isAdmin) {
    return (
      <Badge className="bg-blue-600 hover:bg-blue-700 text-white gap-1">
        <Shield className="w-3 h-3" />
        Admin
      </Badge>
    );
  }
  
  return (
    <Badge variant="secondary" className="gap-1">
      <User className="w-3 h-3" />
      Agent
    </Badge>
    );
}

// In the header, add next to user info:
<div className="flex items-center gap-2">
  <span>{user.firstName} {user.lastName}</span>
  <UserRoleBadge />
</div>
```

---

### 1.2 User Dropdown Menu

Show role in the user dropdown menu:

```tsx
// In user dropdown/popover component

<DropdownMenuLabel className="font-normal">
  <div className="flex flex-col space-y-1">
    <p className="text-sm font-medium">{user.firstName} {user.lastName}</p>
    <p className="text-xs text-muted-foreground">{user.email}</p>
    <div className="pt-1">
      <UserRoleBadge />
    </div>
  </div>
</DropdownMenuLabel>
```

---

### 1.3 Admin Navigation Link (Super Admin Only)

Show Admin menu item only for Super Admins:

```tsx
// In sidebar or navigation component

import { usePermissions } from '@/hooks/use-permissions';

function Navigation() {
  const { isSuperAdmin } = usePermissions();
  
  return (
    <nav>
      {/* Regular nav items */}
      <NavLink to="/dashboard">Dashboard</NavLink>
      <NavLink to="/cmas">CMAs</NavLink>
      
      {/* Super Admin Only */}
      {isSuperAdmin && (
        <>
          <NavSeparator />
          <NavLabel>Administration</NavLabel>
          <NavLink to="/admin/users">
            <Users className="w-4 h-4 mr-2" />
            User Management
          </NavLink>
          <NavLink to="/admin/activity-logs">
            <FileText className="w-4 h-4 mr-2" />
            Activity Logs
          </NavLink>
        </>
      )}
    </nav>
  );
}
```

---

### 1.4 Profile Page Role Display

Show role on user's own profile page:

```tsx
// client/src/pages/Profile.tsx or Settings.tsx

<Card>
  <CardHeader>
    <CardTitle>Account Information</CardTitle>
  </CardHeader>
  <CardContent className="space-y-4">
    <div>
      <Label>Name</Label>
      <p>{user.firstName} {user.lastName}</p>
    </div>
    <div>
      <Label>Email</Label>
      <p>{user.email}</p>
    </div>
    <div>
      <Label>Role</Label>
      <div className="mt-1">
        <UserRoleBadge />
      </div>
    </div>
    <div>
      <Label>Member Since</Label>
      <p>{formatDate(user.createdAt)}</p>
    </div>
  </CardContent>
</Card>
```

---

## PART 2: Render Deployment Readiness

### 2.1 Environment Variables

Ensure all environment variables are properly configured for Render:

```bash
# Required Environment Variables for Render

# Database (Render PostgreSQL or external)
DATABASE_URL=postgresql://user:password@host:5432/database

# Session Secret (generate a strong random string)
SESSION_SECRET=your-secure-random-string-min-32-chars

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_CALLBACK_URL=https://your-app.onrender.com/auth/google/callback

# Mapbox (for CMA maps)
MAPBOX_ACCESS_TOKEN=pk.your-mapbox-token

# Repliers API
REPLIERS_API_KEY=your-repliers-api-key

# App URL (for OAuth redirects)
APP_URL=https://your-app.onrender.com

# Node Environment
NODE_ENV=production

# Port (Render sets this automatically, but have fallback)
PORT=10000
```

---

### 2.2 Update Server for Render Compatibility

```typescript
// server/index.ts - Ensure these are set correctly

// Trust proxy (Render uses reverse proxy)
app.set('trust proxy', 1);

// Port from environment
const PORT = process.env.PORT || 5000;

// Session configuration for production
app.use(session({
  store: new PostgresStore({
    conString: process.env.DATABASE_URL,
    createTableIfMissing: true,
  }),
  secret: process.env.SESSION_SECRET!,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only in production
    httpOnly: true,
    sameSite: process.env.NODE_ENV === 'production' ? 'none' : 'lax',
    maxAge: 1000 * 60 * 60 * 24 * 7, // 7 days
    domain: process.env.NODE_ENV === 'production' ? '.onrender.com' : undefined,
  },
}));

// CORS configuration for production
app.use(cors({
  origin: process.env.NODE_ENV === 'production' 
    ? process.env.APP_URL 
    : 'http://localhost:5173',
  credentials: true,
}));
```

---

### 2.3 Database Connection for Render

```typescript
// server/db.ts or database configuration

import { drizzle } from 'drizzle-orm/node-postgres';
import { Pool } from 'pg';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
});

export const db = drizzle(pool);
```

---

### 2.4 Google OAuth Callback URL

Update Google OAuth to handle both development and production:

```typescript
// server/auth.ts

const GOOGLE_CALLBACK_URL = process.env.GOOGLE_CALLBACK_URL || 
  (process.env.NODE_ENV === 'production'
    ? 'https://your-app.onrender.com/auth/google/callback'
    : 'http://localhost:5000/auth/google/callback');

passport.use(new GoogleStrategy({
  clientID: process.env.GOOGLE_CLIENT_ID!,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
  callbackURL: GOOGLE_CALLBACK_URL,
}, async (accessToken, refreshToken, profile, done) => {
  // ... existing logic
}));
```

---

### 2.5 Health Check Endpoint

Add a health check endpoint for Render:

```typescript
// server/routes.ts or server/index.ts

// Health check for Render
app.get('/health', (req, res) => {
  res.status(200).json({ 
    status: 'healthy',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV,
  });
});

// Or simpler version
app.get('/health', (req, res) => {
  res.status(200).send('OK');
});
```

---

### 2.6 Build Script for Render

Ensure `package.json` has proper scripts:

```json
{
  "scripts": {
    "dev": "tsx watch server/index.ts",
    "build": "vite build && tsc -p tsconfig.server.json",
    "start": "node dist/server/index.js",
    "db:push": "drizzle-kit push",
    "db:migrate": "drizzle-kit migrate"
  }
}
```

---

### 2.7 Render Configuration File (Optional)

Create `render.yaml` for Infrastructure as Code:

```yaml
# render.yaml
services:
  - type: web
    name: client-data-portal
    env: node
    buildCommand: npm install && npm run build
    startCommand: npm run start
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: client-data-portal-db
          property: connectionString
      - key: SESSION_SECRET
        generateValue: true
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: MAPBOX_ACCESS_TOKEN
        sync: false
      - key: REPLIERS_API_KEY
        sync: false

databases:
  - name: client-data-portal-db
    plan: starter
```

---

## PART 3: Pre-Deployment Checklist

### Environment Variables:
- [ ] DATABASE_URL set (Render PostgreSQL connection string)
- [ ] SESSION_SECRET set (32+ character random string)
- [ ] GOOGLE_CLIENT_ID set
- [ ] GOOGLE_CLIENT_SECRET set
- [ ] GOOGLE_CALLBACK_URL updated to Render domain
- [ ] MAPBOX_ACCESS_TOKEN set
- [ ] REPLIERS_API_KEY set
- [ ] NODE_ENV=production

### Google OAuth Console:
- [ ] Add Render domain to authorized JavaScript origins
- [ ] Add Render callback URL to authorized redirect URIs
- [ ] Example: `https://your-app.onrender.com/auth/google/callback`

### Database:
- [ ] PostgreSQL database created on Render (or external)
- [ ] SSL enabled for production
- [ ] Run migrations: `npm run db:push` or `npm run db:migrate`

### Code:
- [ ] `trust proxy` enabled
- [ ] Secure cookies in production
- [ ] CORS configured for production domain
- [ ] Health check endpoint added

---

## ACCEPTANCE CRITERIA

### Role Indicator:
- [ ] User can see their role in the header/navbar
- [ ] Role badge shows correct color (purple=Super Admin, blue=Admin, gray=Agent)
- [ ] Admin navigation only visible to Super Admins
- [ ] Role displayed on profile/settings page

### Render Readiness:
- [ ] All environment variables documented
- [ ] Database connection handles SSL
- [ ] Session cookies configured for production
- [ ] OAuth callback URLs are environment-based
- [ ] Health check endpoint responds with 200
- [ ] Build and start scripts work correctly

---

## FILES TO MODIFY

```
client/src/
├── components/
│   ├── layout/
│   │   ├── Header.tsx         [MODIFY - add role badge]
│   │   ├── Sidebar.tsx        [MODIFY - admin nav links]
│   │   └── UserDropdown.tsx   [MODIFY - show role]
│   └── UserRoleBadge.tsx      [CREATE - reusable badge]
├── pages/
│   └── Profile.tsx            [MODIFY - show role]

server/
├── index.ts                   [MODIFY - trust proxy, session config]
├── db.ts                      [MODIFY - SSL for production]
├── auth.ts                    [MODIFY - dynamic callback URL]
└── routes.ts                  [MODIFY - add health check]

render.yaml                    [CREATE - optional IaC config]
```

---

**⚠️ REMINDER: Test role indicator visibility AND verify all environment variables before deployment!**