# Phase 2: Mapbox Integration for Maps

## Overview
Replace Google Maps with Mapbox for the "Map of All Listings" section in the CMA Presentation. This reduces costs and provides better customization options.

## Mapbox Style URLs
- Streets: mapbox://styles/mapbox/streets-v11
- Satellite: mapbox://styles/mapbox/satellite-streets-v11
- Dark: mapbox://styles/mapbox/dark-v10

---

## Task 2.1: Install Mapbox Dependencies
```bash
npm install mapbox-gl @types/mapbox-gl react-map-gl
```

---

## Task 2.2: Create Mapbox Map Component
```jsx
// components/presentation/MapboxCMAMap.tsx
import { useRef, useEffect, useState } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';

interface Property {
  mlsNumber: string;
  address: string;
  lat: number;
  lng: number;
  price: number;
  status: 'Active' | 'Active Under Contract' | 'Closed';
  isSubject?: boolean;
}

interface MapboxCMAMapProps {
  properties: Property[];
  subjectProperty?: Property;
  style?: 'streets' | 'satellite' | 'dark';
  showPolygon?: boolean;
  onStyleChange?: (style: string) => void;
}

const MAPBOX_STYLES = {
  streets: 'mapbox://styles/mapbox/streets-v11',
  satellite: 'mapbox://styles/mapbox/satellite-streets-v11',
  dark: 'mapbox://styles/mapbox/dark-v10'
};

const STATUS_COLORS = {
  'Active': '#22c55e',           // Green
  'Active Under Contract': '#f97316', // Orange
  'Closed': '#6b7280',           // Gray
  'Subject': '#ef4444'           // Red for subject property
};

export function MapboxCMAMap({ 
  properties, 
  subjectProperty,
  style = 'streets',
  showPolygon = true,
  onStyleChange
}: MapboxCMAMapProps) {
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<mapboxgl.Map | null>(null);
  const [mapLoaded, setMapLoaded] = useState(false);

  // Initialize map
  useEffect(() => {
    if (!mapContainer.current || map.current) return;

    mapboxgl.accessToken = process.env.NEXT_PUBLIC_MAPBOX_TOKEN || '';

    map.current = new mapboxgl.Map({
      container: mapContainer.current,
      style: MAPBOX_STYLES[style],
      center: getCenterPoint(properties, subjectProperty),
      zoom: 12
    });

    map.current.on('load', () => {
      setMapLoaded(true);
    });

    // Add navigation controls
    map.current.addControl(new mapboxgl.NavigationControl(), 'top-right');

    return () => {
      map.current?.remove();
      map.current = null;
    };
  }, []);

  // Update style when changed
  useEffect(() => {
    if (map.current && mapLoaded) {
      map.current.setStyle(MAPBOX_STYLES[style]);
    }
  }, [style, mapLoaded]);

  // Add markers and polygon when map loads
  useEffect(() => {
    if (!map.current || !mapLoaded) return;

    // Clear existing markers
    const existingMarkers = document.querySelectorAll('.mapbox-marker');
    existingMarkers.forEach(m => m.remove());

    // Add subject property marker (larger, red)
    if (subjectProperty) {
      const el = createMarkerElement(subjectProperty, true);
      new mapboxgl.Marker(el)
        .setLngLat([subjectProperty.lng, subjectProperty.lat])
        .setPopup(createPopup(subjectProperty, true))
        .addTo(map.current);
    }

    // Add comparable property markers
    properties.forEach(property => {
      if (property.mlsNumber === subjectProperty?.mlsNumber) return;
      
      const el = createMarkerElement(property, false);
      new mapboxgl.Marker(el)
        .setLngLat([property.lng, property.lat])
        .setPopup(createPopup(property, false))
        .addTo(map.current!);
    });

    // Add polygon connecting all properties
    if (showPolygon && properties.length >= 3) {
      addPolygonLayer(map.current, properties, subjectProperty);
    }

    // Fit bounds to show all markers
    fitBoundsToMarkers(map.current, properties, subjectProperty);

  }, [properties, subjectProperty, mapLoaded, showPolygon]);

  return (
    <div className="relative">
      {/* Map Container */}
      <div 
        ref={mapContainer} 
        className="w-full h-[400px] rounded-lg overflow-hidden"
      />
      
      {/* Style Selector */}
      <div className="absolute top-3 left-3 bg-white rounded-lg shadow-md p-1 flex gap-1">
        {Object.keys(MAPBOX_STYLES).map((s) => (
          <button
            key={s}
            onClick={() => onStyleChange?.(s)}
            className={`
              px-3 py-1.5 text-xs font-medium rounded capitalize
              ${style === s 
                ? 'bg-orange-500 text-white' 
                : 'hover:bg-gray-100 text-gray-700'
              }
            `}
          >
            {s}
          </button>
        ))}
      </div>
      
      {/* Legend */}
      <div className="absolute bottom-3 left-3 bg-white rounded-lg shadow-md p-3">
        <div className="text-xs font-medium mb-2">Legend</div>
        <div className="space-y-1">
          <div className="flex items-center gap-2 text-xs">
            <span className="w-3 h-3 rounded-full bg-red-500" />
            <span>Subject Property</span>
          </div>
          <div className="flex items-center gap-2 text-xs">
            <span className="w-3 h-3 rounded-full bg-green-500" />
            <span>Active</span>
          </div>
          <div className="flex items-center gap-2 text-xs">
            <span className="w-3 h-3 rounded-full bg-orange-500" />
            <span>Under Contract</span>
          </div>
          <div className="flex items-center gap-2 text-xs">
            <span className="w-3 h-3 rounded-full bg-gray-500" />
            <span>Closed</span>
          </div>
        </div>
      </div>
    </div>
  );
}

// Helper functions
function createMarkerElement(property: Property, isSubject: boolean): HTMLElement {
  const el = document.createElement('div');
  el.className = 'mapbox-marker';
  el.style.width = isSubject ? '24px' : '18px';
  el.style.height = isSubject ? '24px' : '18px';
  el.style.borderRadius = '50%';
  el.style.backgroundColor = isSubject 
    ? STATUS_COLORS.Subject 
    : STATUS_COLORS[property.status];
  el.style.border = '3px solid white';
  el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
  el.style.cursor = 'pointer';
  return el;
}

function createPopup(property: Property, isSubject: boolean): mapboxgl.Popup {
  return new mapboxgl.Popup({ offset: 25 }).setHTML(`
    <div class="p-2">
      <div class="font-semibold">${property.address}</div>
      <div class="text-sm text-gray-600">
        ${isSubject ? 'Subject Property' : property.status}
      </div>
      <div class="text-sm font-medium text-orange-600">
        $${property.price.toLocaleString()}
      </div>
    </div>
  `);
}

function addPolygonLayer(
  map: mapboxgl.Map, 
  properties: Property[], 
  subject?: Property
) {
  // Remove existing polygon layer if present
  if (map.getLayer('property-polygon')) {
    map.removeLayer('property-polygon');
    map.removeSource('property-polygon');
  }

  // Create convex hull or bounding polygon
  const allProps = subject ? [subject, ...properties] : properties;
  const coordinates = allProps.map(p => [p.lng, p.lat]);
  
  // Close the polygon
  if (coordinates.length > 0) {
    coordinates.push(coordinates[0]);
  }

  map.addSource('property-polygon', {
    type: 'geojson',
    data: {
      type: 'Feature',
      properties: {},
      geometry: {
        type: 'Polygon',
        coordinates: [coordinates]
      }
    }
  });

  map.addLayer({
    id: 'property-polygon',
    type: 'fill',
    source: 'property-polygon',
    paint: {
      'fill-color': '#f97316',
      'fill-opacity': 0.1
    }
  });

  map.addLayer({
    id: 'property-polygon-outline',
    type: 'line',
    source: 'property-polygon',
    paint: {
      'line-color': '#f97316',
      'line-width': 2,
      'line-dasharray': [2, 2]
    }
  });
}

function fitBoundsToMarkers(
  map: mapboxgl.Map, 
  properties: Property[], 
  subject?: Property
) {
  const allProps = subject ? [subject, ...properties] : properties;
  if (allProps.length === 0) return;

  const bounds = new mapboxgl.LngLatBounds();
  allProps.forEach(p => bounds.extend([p.lng, p.lat]));
  
  map.fitBounds(bounds, { padding: 50 });
}

function getCenterPoint(properties: Property[], subject?: Property) {
  if (subject) return [subject.lng, subject.lat] as [number, number];
  if (properties.length === 0) return [-97.7431, 30.2672] as [number, number]; // Austin default
  return [properties[0].lng, properties[0].lat] as [number, number];
}
```

---

## Task 2.3: Add Map Style Selection to Layout Tab
```jsx
// In Layout tab settings
<div className="space-y-4">
  <h4 className="font-medium">Map Settings</h4>
  
  <div>
    <label className="block text-sm font-medium mb-2">Map Style</label>
    <div className="grid grid-cols-3 gap-2">
      {[
        { id: 'streets', label: 'Streets', preview: '/map-previews/streets.png' },
        { id: 'satellite', label: 'Satellite', preview: '/map-previews/satellite.png' },
        { id: 'dark', label: 'Dark', preview: '/map-previews/dark.png' }
      ].map(style => (
        <button
          key={style.id}
          onClick={() => updateConfig('layout.mapStyle', style.id)}
          className={`
            border rounded-lg p-2 text-center transition-all
            ${config.layout.mapStyle === style.id 
              ? 'border-orange-500 bg-orange-50' 
              : 'hover:border-gray-300'
            }
          `}
        >
          <div className="aspect-video bg-gray-100 rounded mb-2 overflow-hidden">
            <img src={style.preview} alt={style.label} className="w-full h-full object-cover" />
          </div>
          <span className="text-sm">{style.label}</span>
        </button>
      ))}
    </div>
  </div>
  
  <div className="flex items-center justify-between">
    <div>
      <label className="font-medium">Show Search Area Polygon</label>
      <p className="text-sm text-gray-500">Display boundary around all properties</p>
    </div>
    <Switch 
      checked={config.layout.showPolygon}
      onCheckedChange={(v) => updateConfig('layout.showPolygon', v)}
    />
  </div>
</div>
```

---

## Task 2.4: Environment Configuration
```env
# .env
NEXT_PUBLIC_MAPBOX_TOKEN=pk.your_mapbox_token_here
```

---

## Task 2.5: Static Map for PDF Export

For PDF export, generate a static map image:
```typescript
// utils/generateStaticMap.ts
export function generateMapboxStaticMapUrl(
  properties: Property[],
  subjectProperty: Property | undefined,
  style: 'streets' | 'satellite' | 'dark' = 'streets',
  width: number = 800,
  height: number = 400
): string {
  const token = process.env.NEXT_PUBLIC_MAPBOX_TOKEN;
  const styleId = {
    streets: 'streets-v11',
    satellite: 'satellite-streets-v11',
    dark: 'dark-v10'
  }[style];

  // Create GeoJSON overlay for markers
  const markers = properties.map(p => 
    `pin-s-${p.status === 'Closed' ? 'c' : 'a'}+${getStatusColor(p.status)}(${p.lng},${p.lat})`
  );
  
  if (subjectProperty) {
    markers.unshift(`pin-l-star+ef4444(${subjectProperty.lng},${subjectProperty.lat})`);
  }

  // Calculate auto bounds
  const bounds = calculateBounds(properties, subjectProperty);
  
  return `https://api.mapbox.com/styles/v1/mapbox/${styleId}/static/${markers.join(',')}/${bounds}/${width}x${height}@2x?access_token=${token}`;
}

function getStatusColor(status: string): string {
  const colors = {
    'Active': '22c55e',
    'Active Under Contract': 'f97316',
    'Closed': '6b7280'
  };
  return colors[status] || '6b7280';
}
```

---

## Acceptance Criteria

- [ ] Mapbox map renders in Live Preview
- [ ] Three style options: Streets, Satellite, Dark
- [ ] Subject property shown with larger red marker
- [ ] Comparable properties color-coded by status
- [ ] Polygon boundary shown connecting all properties
- [ ] Popup on marker click shows property details
- [ ] Map style persists in configuration
- [ ] Static map image used in PDF export
- [ ] Legend displays in corner of map