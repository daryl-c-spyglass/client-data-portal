# CMA Stats View - Complete Charts Implementation

## SCOPE

Implement the Stats view with three chart sections matching Contract Conduit:
1. **Price Comparison** - Bar chart below Statistics Summary
2. **Days on Market** - Scrollable list + scatter chart 
3. **Average Price/Sq. Ft.** - Scrollable list + scatter chart

---

## SECTION 1: Price Comparison Bar Chart

**Location:** Below "Statistics Summary (X Properties)" table

```tsx
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

function PriceComparisonChart({ properties }: { properties: CMAComparable[] }) {
  const data = properties.map(p => ({
    name: p.address?.split(',')[0] || p.mlsNumber,
    price: p.price || p.soldPrice || p.listPrice,
  }));

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base flex items-center gap-2">
          <BarChart3 className="w-4 h-4" />
          Price Comparison
        </CardTitle>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={data} margin={{ bottom: 80 }}>
            <XAxis 
              dataKey="name" 
              angle={-45} 
              textAnchor="end" 
              height={100}
              tick={{ fontSize: 11 }}
              interval={0}
            />
            <YAxis 
              tickFormatter={(v) => `$${(v / 1000000).toFixed(1)}M`}
              tick={{ fontSize: 11 }}
            />
            <Tooltip formatter={(v: number) => [`$${v.toLocaleString()}`, 'Price']} />
            <Bar dataKey="price" fill="#EF4923" radius={[4, 4, 0, 0]} />
          </BarChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
```

---

## SECTION 2: Days on Market Analysis

**Location:** Below "CMA Market Review"

### Component:

```tsx
import { ScatterChart, Scatter, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';

function DaysOnMarketSection({ 
  closedProperties, 
  onPropertyClick 
}: { 
  closedProperties: CMAComparable[];
  onPropertyClick?: (p: CMAComparable) => void;
}) {
  // Calculate averages
  const avgDOM = closedProperties.length > 0
    ? Math.round(closedProperties.reduce((sum, p) => sum + (p.daysOnMarket || 0), 0) / closedProperties.length)
    : 0;
  
  const avgListPriceRatio = closedProperties.length > 0
    ? closedProperties
        .filter(p => p.listPrice && (p.soldPrice || p.price))
        .reduce((sum, p) => sum + ((p.soldPrice || p.price) / p.listPrice) * 100, 0) / 
      closedProperties.filter(p => p.listPrice && (p.soldPrice || p.price)).length
    : 100;

  // Scatter data
  const scatterData = closedProperties.map(p => {
    const soldPrice = p.soldPrice || p.price;
    const ratio = p.listPrice ? (soldPrice / p.listPrice) * 100 : 100;
    return {
      x: p.daysOnMarket || 0,
      y: soldPrice,
      name: p.address?.split(',')[0],
      ratio,
      property: p,
    };
  });

  const getPointColor = (ratio: number) => {
    if (ratio >= 100) return '#22c55e'; // Green
    if (ratio >= 95) return '#f59e0b';  // Yellow
    return '#ef4444';                    // Red
  };

  return (
    <Card>
      <CardHeader className="pb-2">
        <div className="flex items-center gap-6">
          <div>
            <span className="text-3xl font-bold">{avgDOM}</span>
            <span className="text-muted-foreground ml-2 text-sm">DAYS ON MARKET</span>
          </div>
          <div>
            <span className="text-3xl font-bold text-[#EF4923]">{avgListPriceRatio.toFixed(2)}%</span>
            <span className="text-muted-foreground ml-2 text-sm">OF LIST PRICE</span>
          </div>
        </div>
        <p className="text-sm text-muted-foreground mt-2">
          Sold homes were on the market for an average of{' '}
          <span className="font-semibold text-foreground">{avgDOM} days</span>{' '}
          before they accepted an offer. These homes sold for an average of{' '}
          <span className="font-semibold text-foreground">{avgListPriceRatio.toFixed(2)}%</span>{' '}
          of list price.
        </p>
      </CardHeader>
      
      <CardContent>
        <div className="flex gap-6">
          {/* Left: Scrollable Property List */}
          <div className="w-1/3 flex-shrink-0">
            <div className="flex items-center gap-2 mb-3">
              <span className="bg-red-500 text-white text-xs font-medium px-2 py-0.5 rounded">
                {closedProperties.length}
              </span>
              <span className="font-medium">Closed</span>
            </div>
            
            <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2">
              {closedProperties.map((property) => {
                const soldPrice = property.soldPrice || property.price;
                const ratio = property.listPrice 
                  ? ((soldPrice / property.listPrice) * 100).toFixed(2)
                  : '100.00';
                
                return (
                  <div 
                    key={property.mlsNumber}
                    onClick={() => onPropertyClick?.(property)}
                    className="flex items-center gap-3 p-2 rounded-lg hover:bg-muted cursor-pointer"
                  >
                    <div className="w-14 h-12 bg-muted rounded overflow-hidden flex-shrink-0">
                      {property.photos?.[0] ? (
                        <img src={property.photos[0]} alt="" className="w-full h-full object-cover" />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-xs text-muted-foreground">
                          No img
                        </div>
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-sm truncate">{property.address?.split(',')[0]}</p>
                      <p className="text-xs text-muted-foreground">
                        {property.daysOnMarket} Days • {ratio}%
                      </p>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
          
          {/* Right: Scatter Chart */}
          <div className="flex-1">
            <ResponsiveContainer width="100%" height={300}>
              <ScatterChart margin={{ top: 20, right: 20, bottom: 40, left: 60 }}>
                <XAxis 
                  type="number" 
                  dataKey="x" 
                  tick={{ fontSize: 11 }}
                  label={{ value: 'Days on Market', position: 'bottom', offset: 20, fontSize: 12 }}
                />
                <YAxis 
                  type="number" 
                  dataKey="y" 
                  tickFormatter={(v) => `$${(v / 1000).toFixed(0)}K`}
                  tick={{ fontSize: 11 }}
                />
                <Tooltip 
                  content={({ payload }) => {
                    if (!payload?.[0]) return null;
                    const data = payload[0].payload;
                    return (
                      <div className="bg-white dark:bg-gray-800 p-2 rounded shadow-lg border text-sm">
                        <p className="font-semibold">{data.name}</p>
                        <p>Price: ${data.y?.toLocaleString()}</p>
                        <p>DOM: {data.x} days</p>
                        <p>List Ratio: {data.ratio?.toFixed(2)}%</p>
                      </div>
                    );
                  }}
                />
                <Scatter data={scatterData}>
                  {scatterData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={getPointColor(entry.ratio)} />
                  ))}
                </Scatter>
              </ScatterChart>
            </ResponsiveContainer>
            
            {/* Legend */}
            <div className="flex items-center justify-center gap-6 mt-2 text-sm">
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-[#22c55e]" />
                <span>≥100% of list</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-[#f59e0b]" />
                <span>95-99%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-[#ef4444]" />
                <span>&lt;95%</span>
              </div>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

---

## SECTION 3: Average Price/Sq. Ft. Analysis

**Location:** Below Days on Market section

```tsx
function PricePerSqftSection({ 
  closedProperties, 
  subjectProperty,
  onPropertyClick 
}: { 
  closedProperties: CMAComparable[];
  subjectProperty: PropertySnapshot;
  onPropertyClick?: (p: any) => void;
}) {
  const [showSubject, setShowSubject] = useState(true);
  const [showClosed, setShowClosed] = useState(true);
  
  // Calculate avg $/sqft
  const avgPricePerSqft = closedProperties.length > 0
    ? Math.round(
        closedProperties
          .filter(p => p.sqft && p.sqft > 0)
          .reduce((sum, p) => sum + ((p.soldPrice || p.price) / p.sqft!), 0) / 
        closedProperties.filter(p => p.sqft && p.sqft > 0).length
      )
    : 0;
  
  const subjectPricePerSqft = subjectProperty?.sqft 
    ? Math.round((subjectProperty.listPrice || 0) / subjectProperty.sqft)
    : 0;
  
  // Scatter data
  const scatterData: any[] = [];
  
  if (showSubject && subjectProperty?.sqft) {
    scatterData.push({
      x: subjectProperty.sqft,
      y: subjectProperty.listPrice,
      name: subjectProperty.address?.split(',')[0],
      pricePerSqft: subjectPricePerSqft,
      isSubject: true,
    });
  }
  
  if (showClosed) {
    closedProperties.forEach(p => {
      if (p.sqft) {
        scatterData.push({
          x: p.sqft,
          y: p.soldPrice || p.price,
          name: p.address?.split(',')[0],
          pricePerSqft: Math.round((p.soldPrice || p.price) / p.sqft),
          isSubject: false,
        });
      }
    });
  }

  return (
    <Card>
      <CardHeader className="pb-2">
        <CardTitle className="text-base font-bold">AVERAGE PRICE/SQ. FT.</CardTitle>
        <p className="text-sm text-muted-foreground">
          1 Subject, {closedProperties.length} Closed
        </p>
      </CardHeader>
      
      <CardContent>
        <div className="flex gap-6">
          {/* Left: Property List */}
          <div className="w-1/3 flex-shrink-0">
            {/* Subject Property */}
            {subjectProperty && (
              <div 
                onClick={() => onPropertyClick?.(subjectProperty)}
                className="flex items-center gap-3 p-2 rounded-lg border-b mb-2 pb-3 cursor-pointer hover:bg-muted/50"
              >
                <div className="w-14 h-12 bg-muted rounded overflow-hidden flex-shrink-0">
                  {subjectProperty.photos?.[0] ? (
                    <img src={subjectProperty.photos[0]} alt="" className="w-full h-full object-cover" />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-xs text-muted-foreground">
                      No img
                    </div>
                  )}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-xs text-blue-500">
                    Subject: {subjectProperty.address?.split(',')[0]}
                  </p>
                  <p className="font-semibold text-[#EF4923]">
                    ${subjectPricePerSqft} / sq. ft.
                  </p>
                </div>
              </div>
            )}
            
            {/* Closed Properties */}
            <div className="space-y-2 max-h-[250px] overflow-y-auto pr-2">
              {closedProperties.map((property) => {
                const pricePerSqft = property.sqft 
                  ? Math.round((property.soldPrice || property.price) / property.sqft) 
                  : 0;
                
                return (
                  <div 
                    key={property.mlsNumber}
                    onClick={() => onPropertyClick?.(property)}
                    className="flex items-center gap-3 p-2 rounded-lg hover:bg-muted cursor-pointer"
                  >
                    <div className="w-14 h-12 bg-muted rounded overflow-hidden flex-shrink-0">
                      {property.photos?.[0] ? (
                        <img src={property.photos[0]} alt="" className="w-full h-full object-cover" />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-xs text-muted-foreground">
                          No img
                        </div>
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-sm truncate">{property.address?.split(',')[0]}</p>
                      <p className="font-semibold text-[#EF4923]">${pricePerSqft} / sq. ft.</p>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
          
          {/* Right: Stats + Chart */}
          <div className="flex-1">
            {/* Big Price Display */}
            <div className="mb-4">
              <span className="text-4xl font-bold text-[#EF4923]">${avgPricePerSqft}</span>
              <span className="text-xl text-muted-foreground ml-1">/ Sq. Ft.</span>
              <p className="text-sm text-muted-foreground mt-2">
                Comparable homes sold for an average of{' '}
                <span className="font-semibold text-[#EF4923]">${avgPricePerSqft}</span>/sq. ft. 
                Many factors such as location, use of space, condition, quality, and amenities 
                determine the market value per square foot.
              </p>
            </div>
            
            {/* Scatter Chart */}
            <ResponsiveContainer width="100%" height={250}>
              <ScatterChart margin={{ top: 20, right: 20, bottom: 40, left: 60 }}>
                <XAxis 
                  type="number" 
                  dataKey="x" 
                  tickFormatter={(v) => v.toLocaleString()}
                  tick={{ fontSize: 11 }}
                  label={{ value: 'Square feet', position: 'bottom', offset: 20, fontSize: 12 }}
                />
                <YAxis 
                  type="number" 
                  dataKey="y" 
                  tickFormatter={(v) => `$${(v / 1000).toFixed(0)}K`}
                  tick={{ fontSize: 11 }}
                />
                <Tooltip 
                  content={({ payload }) => {
                    if (!payload?.[0]) return null;
                    const data = payload[0].payload;
                    return (
                      <div className="bg-white dark:bg-gray-800 p-2 rounded shadow-lg border text-sm">
                        <p className="font-semibold">{data.name}</p>
                        <p>Price: ${data.y?.toLocaleString()}</p>
                        <p>Sq Ft: {data.x?.toLocaleString()}</p>
                        <p>$/SqFt: ${data.pricePerSqft}</p>
                      </div>
                    );
                  }}
                />
                <Scatter data={scatterData}>
                  {scatterData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.isSubject ? '#3b82f6' : '#ef4444'} />
                  ))}
                </Scatter>
              </ScatterChart>
            </ResponsiveContainer>
            
            {/* Legend with Checkboxes */}
            <div className="flex items-center justify-center gap-6 mt-2 text-sm">
              <label className="flex items-center gap-2 cursor-pointer">
                <input 
                  type="checkbox" 
                  checked={showSubject}
                  onChange={(e) => setShowSubject(e.target.checked)}
                  className="rounded"
                />
                <div className="w-3 h-3 rounded-full bg-[#3b82f6]" />
                <span>Subject Property</span>
              </label>
              <label className="flex items-center gap-2 cursor-pointer">
                <input 
                  type="checkbox" 
                  checked={showClosed}
                  onChange={(e) => setShowClosed(e.target.checked)}
                  className="rounded"
                />
                <div className="w-3 h-3 rounded-full bg-[#ef4444]" />
                <span>Closed Comparables</span>
              </label>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

---

## STATS VIEW STRUCTURE

```tsx
function CMAStatsView({ properties, subjectProperty }) {
  const closedProperties = properties.filter(p => 
    p.status?.toLowerCase() === 'closed' || p.status?.toLowerCase() === 'sold'
  );
  
  return (
    <div className="space-y-6">
      {/* 1. Summary Cards */}
      <SummaryCards stats={stats} />
      
      {/* 2. Statistics Summary Table */}
      <StatisticsSummaryTable properties={properties} stats={stats} />
      
      {/* 3. Price Comparison Bar Chart */}
      <PriceComparisonChart properties={properties} />
      
      {/* 4. CMA Market Review */}
      <CMAMarketReview properties={properties} stats={stats} />
      
      {/* 5. Days on Market (closed only) */}
      {closedProperties.length > 0 && (
        <DaysOnMarketSection closedProperties={closedProperties} />
      )}
      
      {/* 6. Average Price/Sq. Ft. */}
      {closedProperties.length > 0 && (
        <PricePerSqftSection 
          closedProperties={closedProperties}
          subjectProperty={subjectProperty}
        />
      )}
    </div>
  );
}
```

---

## ACCEPTANCE CRITERIA

- [ ] Price Comparison bar chart with Spyglass orange bars
- [ ] Days on Market section:
  - [ ] Header shows avg DOM and % of list
  - [ ] Scrollable property list with thumbnails
  - [ ] Scatter chart (DOM vs Price)
  - [ ] Color legend (green/yellow/red)
- [ ] Price/Sq.Ft section:
  - [ ] Subject property highlighted at top
  - [ ] Scrollable closed properties list
  - [ ] Big $/sqft display
  - [ ] Scatter chart (SqFt vs Price)
  - [ ] Checkbox filters for subject/closed
- [ ] Property items clickable (opens modal)
- [ ] Dark mode compatible

---

## FILES TO CREATE

```
client/src/components/cma/
├── CMAStatsView.tsx
├── charts/
│   ├── PriceComparisonChart.tsx
│   ├── DaysOnMarketSection.tsx
│   └── PricePerSqftSection.tsx
```

---

Ready to implement!