ðŸ”§ REPLIT PROMPT: Migrate All Maps to Mapbox
SCOPE
Migrate all map components in the Client Data Portal from Leaflet/OpenStreetMap to Mapbox for visual consistency and to align with the cost optimization strategy. Fix the Mapbox token configuration issue in the Presentation Builder.

CURRENT STATE
LocationCurrent ImplementationTargetCMA Detail Page (Map tab)Leaflet + OpenStreetMapMapboxPresentation Builder PreviewMapbox (broken - token error)Mapbox (fixed)Buyer Search Map (if exists)Unknown - checkMapboxProperty Detail Maps (if any)Unknown - checkMapbox
Environment variable: VITE_MAPBOX_TOKEN is configured (confirmed in audit)

TASK 1: Audit All Map Components
First, find all map implementations in the codebase:
bash# Search for map-related imports and components
grep -r "leaflet" client/src --include="*.tsx" --include="*.ts"
grep -r "mapbox" client/src --include="*.tsx" --include="*.ts"
grep -r "OpenStreetMap" client/src --include="*.tsx" --include="*.ts"
grep -r "MapContainer" client/src --include="*.tsx" --include="*.ts"
grep -r "react-map-gl" client/src --include="*.tsx" --include="*.ts"
List all files that contain map implementations and their current library.

TASK 2: Fix Mapbox Token in Presentation Builder
Issue: Presentation Builder shows "Mapbox token not configured" despite VITE_MAPBOX_TOKEN being set.
Diagnose:

Find the map component used in client/src/pages/CMAPresentationBuilder.tsx
Check how it accesses the Mapbox token
Verify the token is being read correctly: import.meta.env.VITE_MAPBOX_TOKEN

Common fixes:
typescript// Correct way to access Vite env vars
const mapboxToken = import.meta.env.VITE_MAPBOX_TOKEN;

// Check if token exists before rendering
if (!mapboxToken) {
  console.error("Mapbox token not found. Check VITE_MAPBOX_TOKEN env var.");
}
Ensure:

Token is accessed via import.meta.env.VITE_MAPBOX_TOKEN (not process.env)
Component gracefully handles missing token with proper error message
Token is passed correctly to the Mapbox component


TASK 3: Create Reusable Mapbox Map Component
Create: client/src/components/maps/MapboxMap.tsx
typescriptimport React, { useRef, useEffect, useState } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';

interface MapMarker {
  id: string;
  latitude: number;
  longitude: number;
  label?: string;
  price?: number;
  status?: 'active' | 'under_contract' | 'closed' | 'subject';
  onClick?: () => void;
}

interface MapboxMapProps {
  markers: MapMarker[];
  center?: [number, number]; // [lng, lat]
  zoom?: number;
  height?: string;
  showLegend?: boolean;
  interactive?: boolean;
  onMarkerClick?: (markerId: string) => void;
  className?: string;
}

const STATUS_COLORS = {
  active: '#22c55e',        // Green
  under_contract: '#f97316', // Orange
  closed: '#ef4444',        // Red
  subject: '#3b82f6',       // Blue
};

export function MapboxMap({
  markers,
  center,
  zoom = 12,
  height = '400px',
  showLegend = true,
  interactive = true,
  onMarkerClick,
  className = '',
}: MapboxMapProps) {
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<mapboxgl.Map | null>(null);
  const [mapError, setMapError] = useState<string | null>(null);

  const mapboxToken = import.meta.env.VITE_MAPBOX_TOKEN;

  useEffect(() => {
    if (!mapboxToken) {
      setMapError('Mapbox token not configured. Please set VITE_MAPBOX_TOKEN.');
      console.error('Mapbox token missing');
      return;
    }

    if (!mapContainer.current || map.current) return;

    mapboxgl.accessToken = mapboxToken;

    // Calculate center from markers if not provided
    const mapCenter = center || calculateCenter(markers);

    try {
      map.current = new mapboxgl.Map({
        container: mapContainer.current,
        style: 'mapbox://styles/mapbox/streets-v12',
        center: mapCenter,
        zoom: zoom,
        interactive: interactive,
      });

      // Add navigation controls
      if (interactive) {
        map.current.addControl(new mapboxgl.NavigationControl(), 'top-left');
      }

      // Add markers
      markers.forEach((marker) => {
        const el = createMarkerElement(marker);
        
        const mapboxMarker = new mapboxgl.Marker(el)
          .setLngLat([marker.longitude, marker.latitude])
          .addTo(map.current!);

        if (onMarkerClick) {
          el.addEventListener('click', () => onMarkerClick(marker.id));
        }

        // Add popup with price
        if (marker.price) {
          const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(
            `<div class="font-semibold">$${marker.price.toLocaleString()}</div>
             ${marker.label ? `<div class="text-sm text-gray-600">${marker.label}</div>` : ''}`
          );
          mapboxMarker.setPopup(popup);
        }
      });

      // Fit bounds to show all markers
      if (markers.length > 1) {
        const bounds = new mapboxgl.LngLatBounds();
        markers.forEach((marker) => {
          bounds.extend([marker.longitude, marker.latitude]);
        });
        map.current.fitBounds(bounds, { padding: 50 });
      }
    } catch (error) {
      console.error('Mapbox initialization error:', error);
      setMapError('Failed to initialize map');
    }

    return () => {
      map.current?.remove();
      map.current = null;
    };
  }, [mapboxToken, markers, center, zoom, interactive]);

  if (mapError) {
    return (
      <div 
        className={`flex items-center justify-center bg-gray-100 rounded-lg ${className}`}
        style={{ height }}
      >
        <div className="text-center text-gray-500">
          <p className="font-medium">{mapError}</p>
          <p className="text-sm mt-1">Please configure VITE_MAPBOX_TOKEN</p>
        </div>
      </div>
    );
  }

  return (
    <div className={`relative ${className}`}>
      <div ref={mapContainer} style={{ height }} className="rounded-lg" />
      
      {showLegend && (
        <div className="absolute bottom-4 left-4 bg-white rounded-lg shadow-md p-3 text-sm">
          <div className="flex items-center gap-2 mb-1">
            <span className="w-3 h-3 rounded-full bg-green-500"></span>
            <span>Active</span>
          </div>
          <div className="flex items-center gap-2 mb-1">
            <span className="w-3 h-3 rounded-full bg-orange-500"></span>
            <span>Under Contract</span>
          </div>
          <div className="flex items-center gap-2 mb-1">
            <span className="w-3 h-3 rounded-full bg-red-500"></span>
            <span>Closed</span>
          </div>
          <div className="flex items-center gap-2">
            <span className="w-3 h-3 rounded-full bg-blue-500"></span>
            <span>Subject</span>
          </div>
        </div>
      )}
    </div>
  );
}

function calculateCenter(markers: MapMarker[]): [number, number] {
  if (markers.length === 0) return [-97.7431, 30.2672]; // Austin, TX default
  
  const sumLng = markers.reduce((sum, m) => sum + m.longitude, 0);
  const sumLat = markers.reduce((sum, m) => sum + m.latitude, 0);
  
  return [sumLng / markers.length, sumLat / markers.length];
}

function createMarkerElement(marker: MapMarker): HTMLDivElement {
  const el = document.createElement('div');
  const color = STATUS_COLORS[marker.status || 'active'];
  
  // Price label marker style
  if (marker.price) {
    el.className = 'mapbox-price-marker';
    el.innerHTML = `
      <div style="
        background-color: ${color};
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      ">
        $${(marker.price / 1000).toFixed(0)}K
      </div>
    `;
  } else {
    // Simple dot marker
    el.style.cssText = `
      width: 16px;
      height: 16px;
      background-color: ${color};
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    `;
  }
  
  return el;
}

export default MapboxMap;

TASK 4: Migrate CMA Detail Page Map
File: Find the CMA detail page map component (likely in client/src/pages/CMADetailPage.tsx or a component it uses)
Replace Leaflet implementation with MapboxMap:
typescriptimport { MapboxMap } from '@/components/maps/MapboxMap';

// In the Map tab section, replace the Leaflet map with:
<MapboxMap
  markers={comparableProperties.map((prop) => ({
    id: prop.mlsNumber,
    latitude: prop.latitude,
    longitude: prop.longitude,
    price: prop.listPrice || prop.soldPrice,
    status: mapStatusToMarkerStatus(prop.mlsStatus),
    label: prop.address,
  }))}
  height="500px"
  showLegend={true}
  onMarkerClick={(id) => handlePropertyClick(id)}
/>

// Helper function
function mapStatusToMarkerStatus(mlsStatus: string): 'active' | 'under_contract' | 'closed' | 'subject' {
  switch (mlsStatus?.toLowerCase()) {
    case 'active': return 'active';
    case 'active under contract':
    case 'pending': return 'under_contract';
    case 'closed':
    case 'sold': return 'closed';
    default: return 'active';
  }
}

TASK 5: Migrate Presentation Builder Map
File: client/src/pages/CMAPresentationBuilder.tsx (and related components)
Update the "Map of All Listings" preview section to use the new MapboxMap component.
Ensure the map renders correctly in:

Live Preview panel
Exported PDF (may need static image approach for PDF)


TASK 6: Migrate Any Other Maps
Check and migrate these if they exist:

Buyer Search map
Property detail pages
Dashboard maps
Any other location using Leaflet


TASK 7: Remove Leaflet Dependencies (After Migration)
Once all maps are migrated:
bashnpm uninstall leaflet react-leaflet @types/leaflet
Remove any Leaflet CSS imports from the codebase.

TASK 8: Add Mapbox CSS
File: client/src/main.tsx or client/index.html
Ensure Mapbox CSS is imported:
typescriptimport 'mapbox-gl/dist/mapbox-gl.css';

TASK 9: Static Map for PDF Export
For PDF export, Mapbox GL JS won't render directly. Use Mapbox Static Images API:
typescriptfunction getStaticMapUrl(markers: MapMarker[], width = 800, height = 500): string {
  const token = import.meta.env.VITE_MAPBOX_TOKEN;
  
  // Create marker pins for URL
  const pins = markers.map((m) => {
    const color = STATUS_COLORS[m.status || 'active'].replace('#', '');
    return `pin-s+${color}(${m.longitude},${m.latitude})`;
  }).join(',');
  
  // Calculate bounds
  const bounds = calculateBounds(markers);
  
  return `https://api.mapbox.com/styles/v1/mapbox/streets-v12/static/${pins}/auto/${width}x${height}?access_token=${token}`;
}
Use this URL as an <Image> source in the PDF document.

ACCEPTANCE CRITERIA

 VITE_MAPBOX_TOKEN is correctly read via import.meta.env
 CMA Detail Page Map tab uses Mapbox (not Leaflet/OSM)
 Presentation Builder Live Preview shows Mapbox map correctly
 All property markers display with correct status colors
 Price labels show on markers
 Map legend displays correctly
 Zoom/pan controls work
 Map fits bounds to show all markers
 PDF export includes static map image
 No Leaflet/OpenStreetMap references remain (after cleanup)
 Graceful error handling when token is missing


VALIDATION TESTS
javascript// Test 1: Token availability
console.log('Mapbox token exists:', !!import.meta.env.VITE_MAPBOX_TOKEN);

// Test 2: Map renders
// Visual check - map should display without errors

// Test 3: Markers display correctly
// Verify Active (green), Under Contract (orange), Closed (red), Subject (blue)

// Test 4: PDF export
// Export PDF and verify map image is included

LOGGING
javascriptconsole.log('MapboxMap initialized:', { markerCount: markers.length, center, zoom });
console.log('MapboxMap error:', { error: error.message });
console.log('Static map URL generated:', { url, markerCount });
```

---

## FILES LIKELY IMPACTED
```
client/src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ maps/
â”‚       â””â”€â”€ MapboxMap.tsx              [NEW]
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ CMADetailPage.tsx              [MODIFY - replace Leaflet]
â”‚   â””â”€â”€ CMAPresentationBuilder.tsx     [MODIFY - fix token, use MapboxMap]
â”œâ”€â”€ components/
â”‚   â””â”€â”€ CMAPdfDocument.tsx             [MODIFY - use static map image]
â”œâ”€â”€ main.tsx                           [MODIFY - add mapbox CSS import]
â””â”€â”€ index.css                          [MODIFY - remove Leaflet CSS if present]

package.json                           [MODIFY - remove Leaflet deps after migration]

DEPENDENCIES
Add:
bashnpm install mapbox-gl
npm install --save-dev @types/mapbox-gl
Remove (after migration complete):
bashnpm uninstall leaflet react-leaflet @types/leaflet